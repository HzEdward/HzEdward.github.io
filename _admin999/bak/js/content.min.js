function $childNode(o) {
	return window.frames[o]
}

function animationHover(o, e) {
	o = $(o), o.hover(function () {
		o.addClass("animated " + e)
	}, function () {
		window.setTimeout(function () {
			o.removeClass("animated " + e)
		}, 2e3)
	})
}

function WinMove() {
	var o = "[class*=col]",
		e = ".ibox-title",
		i = "[class*=col]";
	$(o).sortable({
		handle: e,
		connectWith: i,
		tolerance: "pointer",
		forcePlaceholderSize: !0,
		opacity: .8
	}).disableSelection()
}
var $parentNode = window.parent.document;
if ($(".tooltip-demo").tooltip({
		selector: "[data-toggle=tooltip]",
		container: "body"
	}), $(".modal").appendTo("body"), $("[data-toggle=popover]").popover(), $(".collapse-link").click(function () {
		var o = $(this).closest("div.ibox"),
			e = $(this).find("i"),
			i = o.find("div.ibox-content");
		i.slideToggle(200), e.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down"), o.toggleClass("").toggleClass("border-bottom"), setTimeout(function () {
			o.resize(), o.find("[id^=map-]").resize()
		}, 50)
	}), $(".close-link").click(function () {
		var o = $(this).closest("div.ibox");
		o.remove()
	}), top == this);
var pytitle = $("#pytitle");
if (parent.$(".layui-layer-title").length > 0) {
	parent.$(".layui-layer-title")[0].innerText = $(document).attr("title")
};
if ($("#content").length > 0) {
	var $ZZZEditor = new UE.getEditor('content', '');
	$('#contentform').submit(function () {
		if ($ZZZEditor.queryCommandState('source') == 1) $ZZZEditor.execCommand('source');
	});
}
if ($("#CodeMirror").length > 0) {
	var $Mirror = CodeMirror.fromTextArea(document.getElementById("CodeMirror"), {
		lineNumbers: true,
		lineWrapping: true,
		matchBrackets: true,
		styleActiveLine: true,
		theme: "ambiance"
	});
}
if ($("#addtime").length > 0) {
	jeDate("#addtime", {
		onClose: false,
		isinitVal: true,
		isTime: true,
		format: "YYYY-MM-DD hh:mm:ss"
	});
}
$("#color").colorpicker().on('changeColor', function (e) {
	$('#title').attr("style", "color:" + e.color.toHex());
});
$("#select_tag").click(function () {
	if ($("#taglist a").length == 0) {
		tagval = $("#tag").val();
		$.post("function.php?act=gettag", function (result) {
			var json = eval(result);
			$.each(json, function (i, item) {
				if (tagval.indexOf(json[i].t_name) >= 0) {
					$selected = "selected";
				} else {
					$selected = "";
				}
				$("#taglist").append("<a class='btn btn-link addtag " + $selected + "'>" + json[i].t_name + "</a>");
			});
		}, 'json')
	}
});
$("#taglist").on("click", ".addtag", function () {
	tagval = $("#tag").val();
	tagtext = $(this).text();
	if ($(this).hasClass("selected")) {
		$(this).removeClass("selected");
		val = tagval.replace(tagtext, "").replace(",,", ",");
	} else {
		$(this).addClass("selected");
		val = tagval + "," + tagtext;
	}
	if (val.substr(0, 1) == ',') val = val.substr(1);
	val = val.replace(/,$/gi, "");
	$("#tag").val(val);
})

function getContentTxt() {
	$("#pagedesc").val($ZZZEditor.getContentTxt());
}
$("#getpinyin").click(function () {
	$.post("function.php?act=pinyin", {
		"sort": $("#title").val()
	}, function (result) {
		pytitle.val(result.substring(0, 30));
		pytitle.focus();
	});
});
pytitle.blur(function () {
	var thisval = $(this).val();
	var oldvalue = $(this).attr("oldvalue");
	var regular = /^([^\`\+\~\!\#\$\%\^\&\*\(\)\|\}\{\=\"\'\！\￥\……\（\）\——]*[\+\~\!\#\$\%\^\&\*\(\)\|\}\{\=\"\'\`\！\?\:\<\>\•\“\”\；\‘\‘\〈\ 〉\￥\……\（\）\——\｛\｝\【\】\\\/\;\：\？\《\》\。\，\、\[\]\,]+.*)$/;
	if (thisval == "") {
		$("#addpage").show();
	} else if (regular.test(thisval)) {
		alert("此网址名称不能含有符号，可以使用-_");
		pytitle.focus();
	}
});

function getKeys() {
	var title = $('#title').val().replace(/[&\|\\\,.;，。？！、*^%$#@\-]/g, ''),
		length = title.length,
		keys = '';
	if (length > 4) {
		for (var i = 0; i < length; i++) {
			if (i > 2 && i % 2 != 0) {
				keys += title[i - 3] + title[i - 2] + title[i - 1] + title[i] + '|'
			}
		}
	} else {
		keys = title
	};
	$('#c_pagekey').val(keys);
}

function switch_ico(ext) {
	$result = '';
	switch (ext) {
		case 'rar':
			$result = 'rar.png';
			break;
		case 'zip':
			$result = 'zip.png';
			break;
		case 'mp4':
		case 'mpeg':
		case 'flv':
		case 'swf':
			$result = 'media.png';
			break;
		case 'pdf':
			$result = 'pdf-2.png';
			break;
		case 'doc':
		case 'docx':
			$result = 'word-2.png';
			break;
		case 'xls':
		case 'xlsx':
			$result = 'excel-2.png';
			break;
		case 'ppt':
		case 'pptx':
			$result = 'ppt-2.png';
			break;
		default:
			$result = 'nk-2.png';
	}
	return $result;
}

function open_upload(file_type,num_type,folder,backid) {
	$r='';del_cookie('upload');
	if(file_type=='image'){
		parent.layer.open({
			type: 2,
			area: ['950px', '690px'],
			content: "?act=imagelist&numtype="+num_type+"&upfolder=" + folder,
			end : function(){
				r=get_cookie('upload');
				if(r){
					r=JSON.parse(r);
					if(num_type==1){
						$("#"+backid).val(r[0].url);	 
						$("#"+backid).change();
						$("#"+backid).blur();
						$("#title").length>0 ? $("#title").val()=='' ? $("#title").val(r[0].title) : '' : '';
						$("#img_"+backid).attr("src",r[0].url+"?"+ Math.random());
					}else{
						$.each(r,function(i,item){
							$r+='<div class="file_item" data-url="'+item['url']+'"><div class="item_file"><div class="item_image"><img src="'+item['url']+'" draggable="false"></div></div><div class="item_del"><i class="fa fa-close "></i></div><div class="item_edit"></div><div class="item_title"><input type="hidden" name="picsurl[]" value="'+item['url']+'"><input type="text" name="picsname[]" value="'+item['title']+'"></div></div>';
						})
					}
				}
				if(num_type==0){
					$("#img_list").prepend($r);
					$('.file_item').arrangeable();
				}
			}
		})
	}else{
		parent.layer.open({
			type: 2,
			area: ['950px', '690px'],
			content: "?act=filelist&filetype="+file_type+"&numtype="+num_type+"&upfolder=" + folder,
			end : function(){
				r=get_cookie('upload');				
				if(r){
					r=JSON.parse(r);
					//console.log(r);
					if(num_type==1){
						$("#"+backid).val(r[0].url);	 
						$("#"+backid).change();						
					}else{
						$.each(r,function(i,item){
							// console.log(item['url']);
							var filepath = item['url'];
							var ext =filepath.substring(filepath.lastIndexOf(".")+1);
							// console.log(ext);
							src='../plugins/template/images/'+switch_ico(ext);
							$r+='<div class="file_item" data-url="'+item['url']+'"><div class="item_file"><div class="item_image"><img src="'+src+'" draggable="false"></div></div><div class="item_del"><i class="fa fa-close "></i></div><div class="item_edit"></div><div class="item_title"><input type="hidden" name="downurl[]" value="'+item['url']+'"><input type="text" name="downname[]" value="'+item['title']+'"></div></div>';
						})
					}
				}
				if(num_type==0){
					$("#file_list").prepend($r);
					$('.file_item').arrangeable();
				}
			}
		})
	}
}

$(".filelist").on("click",".item_file",function() {
	$this=$(this).parent();
	val=$this.data('url');
	console.log(val);
	$this.siblings().removeClass('active').end().addClass('active');
	$("#indexpic").val(val);
	$("#img_indexpic").attr("src", val);	
})

$(".filelist").on("click",".item_del",function(){
	$this=$(this).parents('.file_item');
	$this.remove();
})

$("#indexpic").change(function () {
	$("#img_indexpic").attr("src", $(this).val());
});
$(function () {
	if ($(".chosen-select").length > 0) {
		$(".chosen-select").chosen({
			placeholder_text_multiple: "请选择"
		});
	}
	$('textarea').each(function () {
		$value = this.value;
		$height = this.scrollHeight;
		if ($height == 0) {
			$height = $value.length > 0 ? $value.length : 80;
		}
		if ($height > 200) $height = 200;
		if ($height < 80) $height = 80;
		this.setAttribute('style', 'height:' + ($height) + 'px;');
	}).on('input', function () {
		this.setAttribute('style', 'height:' + this.scrollHeight + 'px;overflow-y:hidden;');
	})
	$(".filelist").on('mouseenter', "li", function () {
		$(this).find(".file-panel").stop().animate({
			height: 30
		});
	});
	$(".filelist").on('mouseleave', "li", function () {
		$(this).find(".file-panel").stop().animate({
			height: 0
		});
	});
	$(".filelist").on('click', 'i', function () {
		var index = $(this).index();
		switch (index) {
			case 0:
				$(this).parent().parent("li").remove();
				return;
			case 1:
				$(this).parent().parent().before($(this).parent().parent().next());
				break;
			case 2:
				$(this).parent().parent().after($(this).parent().parent().prev());
				break;
		}
	});
	$("#file_tbody").on('click', 'i', function () {
		var $class = $(this).attr("class");
		switch ($class) {
			case 'fa fa-remove':
				$(this).parent().parent("tr").remove();
				return;
			case 'fa fa-plus':
				$(this).parent().html("<i class='fa fa-arrow-up'></i> <i class='fa fa-arrow-down'></i> <i class='fa fa-remove'></i>")
				$("#file_tbody").append("<tr class='fileli'><td></td><td><input name='c_downname[]' class='form-control input-sm' value='' placeholder='附件名称'></td> " +
					"<td><input name='c_downurl[]' class='form-control input-sm' value='' placeholder='下载地址'></td>" +
					"<td><i class='fa fa-plus'></i> <i class='fa fa-remove'></i></td></tr>");
			case 'fa fa-arrow-down':
				$(this).parent().parent().before($(this).parent().parent().next());
				break;
			case 'fa fa-arrow-up':
				$(this).parent().parent().after($(this).parent().parent().prev());
				break;
		}
	});
});
//
$(document).keydown(function (e) {
	if (e.ctrlKey && e.keyCode == 13) {
		if ($("#submit").length > 0) {
			$("#submit").click()
		}
	}
	var keyEvent = false;
	switch (e.keyCode) {
		case 27: {
			if ($("#contentform").length > 0) {
				layer.confirm('确定关闭吗？', function () {
					parent.layer.closeAll()
				})
			} else {
				layer.confirm('确定关闭吗？', function () {
					$(parent.parent.document.body).find(".J_tabClosethis").click();
					layer.closeAll();
					parent.layer.closeAll()
				})
			}
		}
		case 8: {
			var d = e.srcElement || e.target;
			if (d.tagName.toUpperCase() == 'INPUT' || d.tagName.toUpperCase() == 'TEXTAREA') {
				keyEvent = d.readOnly || d.disabled;
			} else {
				keyEvent = true;
			}
		}
	}
	if (keyEvent) {
		e.preventDefault();
	}
});

function submitform(table, id, form) {
	var check = true;
	if ($ZZZEditor) {
		if ($ZZZEditor.queryCommandState('source') == 1) $ZZZEditor.execCommand('source');
	}
	if ($Mirror) {
		$("#CodeMirror").val($Mirror.getValue());
	}
	$("#" + form + " .form-control").each(function () {
		$this = $(this);
		var val = $this.val();
		var required = $this.data("required");
		var title = $this.parent().prev('.control-label').text();
		if (!checkstr(val, required)) {
			layer.alert(title + '不符合要求', function (index) {
				$this.focus();
				layer.close(index);
			})
			check = false;
			return false;
		}
	});
	if (check) {
		$.post("save.php?act=" + table, $("#" + form).serialize(), function (result) {
			if (result.return_code > 0) {
				if (result.return_url) {
					parent.layer.confirm(result.return_msg, function () {
						parent.layer.closeAll('dialog');
						parent.tablerefresh();
						location.href = result.return_url;
					}, function () {
						parent.layer.closeAll();
						parent.tablerefresh();
					});
				} else {
					parent.layer.open({
						title: '保存成功',
						content: result.return_msg,
						icon: 1,
						time: 3000,
						end: function () {
							parent.layer.closeAll();
							parent.tablerefresh();
						}
					});
				}
			} else {
				parent.layer.open({
					title: '错误提示',
					content: result.return_msg,
					icon: 2,
					time: 3000
				});
			}
		}, 'json')
	}
}

function checkstr(str, type) {
	switch (type) {
		case 'mobile':
			if (str.match(/^1([0-9])\d{9}$/) == null) {
				return false;
			}
			break;
		case 'password':
			if (str.match(/(?![0-9A-Z]+$)(?![0-9a-z]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,18}$/)) {
				return true;
			} else {
				return false;
			}
			case 'tel':
			case 'phone':
				if (str.match(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/) == null) {
					return false;
				}
				break;
			case 'email':
				if (str.match(/[A-Za-z0-9_-]+[@](\S*)(net|com|cn|org|cc|tv|[0-9]{1,3})(\S*)/g) == null) {
					return false;
				}
				break;
			case 'domain':
				if (str.match(/[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})/g) == null) {
					return false;
				}
				break;
			case 'num':
				var regPos = /^\d+(\.\d+)?$/; //非负浮点数
				var regNeg = /^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$/; //负浮点数
				if (regPos.test(str) || regNeg.test(str)) {
					return true;
				} else {
					return false;
				}
				break;
			case 'nul':
			case '*':
			case 'date':
				if (typeof str == undefined || str == null || str == "" || str == "undefined" || str == "请选择") {
					return false;
				}
				break;
	}
	return true;
}

function format_num(value, scale, zeroed, percented) {
	/*
	 *js格式化数字代码
	 *
	 *value: 要格式化的数字值
	 *scale: 最多保留几位小数
	 *zeroed: 是否保留尾0
	 *percented: 是否转称百分比形式
	 *
	 */
	if (value == null)
		return percented ? '0%' : 0;
	var mr = ('' + value).match(/^\d+\.?\d*$/);
	if (!mr)
		return percented ? '0%' : 0;
	mr = (percented ? (value = Number(mr[0]) * 100) + '' : mr[0]).split('.');
	console.info(mr);
	if (mr.length == 1)
		return (zeroed ? (mr[0] + ((function () {
			var r = '.';
			for (var i = 0; i < scale; i++) {
				r += '0';
			}
			return r;
		}()))) : mr[0]) + (percented ? '%' : '');
	var mr_l = mr[0],
		mr_r = mr[1];
	if (mr_r.length == scale)
		return (zeroed ? (mr_l + '.' + mr_r) : (value + '').replace(/\.*0+$/, '')) + (percented ? '%' : '');
	else if (mr_r.length < scale)
		return (zeroed ? value + ((function () {
			var r = '';
			for (var i = 0; i < scale - mr_r.length; i++) {
				r += '0';
			}
			return r;
		})()) : (value + '').replace(/\.*0+$/, '')) + (percented ? '%' : '');
	else {
		var _s = mr_r.substr(0, scale + 1);
		_s = _s.charAt(scale) > 4 ? (Number(_s.substring(0, scale)) + 1) + '' : _s.substring(0, scale);
		if (_s.length == (scale + 1)) {
			mr_l = (Number(mr_l) + Number(_s.charAt(0))) + '';
			_s = _s.substring(1);
		}
		return (zeroed ? (mr_l + '.' + _s) : (mr_l + (_s.match(/^0*$/) ? '' : ('.' + _s.replace(/0+$/, ''))))) +
			(percented ? '%' : '');
	}
};